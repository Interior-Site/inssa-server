<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.inssa.server.api.board.mapper.ReviewMapper">

    <sql id = "boardColumns">
        BOARD_NO,
        BOARD_NAME,
        BOARD_GUBUN,
        BOARD_TITLE,
        BOARD_CONTENT,
        BOARD_REGDATE,
        BOARD_CHGDATE,
        BOARD_STATUS,
        BOARD_VIEW,
        BOARD_LIKE,
        BOARD_ZZIM,
        BOARD_STAR,
        BOARD_NOTICE,
        BOARD_IMG
        USER_NO
    </sql>


    <insert id="insertBoard" >
        INSERT INTO BOARD
                (BOARD_NO,
                 BOARD_NAME,
                 BOARD_GUBUN,
                 BOARD_TITLE,
                 BOARD_CONTENT,
                 BOARD_REGDATE,
                 BOARD_CHGDATE,
                 BOARD_STATUS,
                 BOARD_VIEW,
                 BOARD_LIKE,
                 BOARD_ZZIM,
                 BOARD_STAR,
                 BOARD_NOTICE,
                 BOARD_IMG,
                 USER_NO)
        VALUES (
<!--                #{boardNo}  시퀀스 생성 후 생성된 시퀀스로 수정해야함-->
                #{boardNo},
                #{boardName},
                'R',
                #{boardTitle},
                #{boardContent},
                now(),
                now(),
                #{boardStatus},
                #{boardView},
                'N',
                'N',
                'N',
                #{boardNotice},
                #{boardImg},
                #{userNo}
        )
    </insert>

    <!-- 게시글 목록 조회 -->
    <select id="selectBoardList" resultType="com.inssa.server.api.board.dto.BoardDto">
        SELECT *
        FROM BOARD
        WHERE BOARD_STATUS = 'Y'
        AND BOARD_GUBUN = 'R'
        ORDER BY BOARD_CHGDATE DESC
    </select>

    <!-- 게시글 상세조회 -->
    <select id="selectBoard" resultType="com.inssa.server.api.board.dto.BoardDto" >
        SELECT *
        FROM BOARD
        WHERE BOARD_NO = #{boardNo}
        AND BOARD_STATUS = 'Y'
    </select>

    <!-- 게시글 수정 -->
    <update id="updateBoard" parameterType="com.inssa.server.api.board.dto.BoardDto">
        UPDATE BOARD
        SET
        BOARD_CHGDATE = NOW(),
        BOARD_TITLE = #{boardTitle},
        BOARD_CONTENT = #{boardContent},
        BOARD_IMG = #{boardImg}
        WHERE BOARD_NO = #{boardNo}
        AND USER_NO = #{userNo}
    </update>

    <!-- 게시글 삭제 : delete 대신 boardStatus 를 'Y'로 변경하여 비활성화 시킨다 -->
    <update id="deleteBoard" parameterType="int">
        UPDATE BOARD
        SET
        BOARD_CHGDATE = NOW(),
        BOARD_STATUS = 'N'
        WHERE BOARD_NO = #{boardNo}
        AND USER_NO = #{userNo}
    </update>

    <!-- 게시글 목록 조회 (검색)-->
    <select id="searchBoardList" resultType="com.inssa.server.api.board.dto.BoardDto" >
        SELECT *
        FROM BOARD
        WHERE BOARD_STATUS = 'Y'
        AND BOARD_GUBUN = 'R'
        <choose>
            <when test="filter != null and type.equals('searchWord')">
                AND searchWord LIKE CONCAT('%', #{boardTitle}, '%')
            </when>

            <when test="filter != null and type.equals('searchWord')">
                AND searchWord LIKE CONCAT('%', #{boardContent}, '%')
            </when>

            <when test="filter != null and type.equals('category')">
                AND BOARD_CATEGORY = #{boardCategory}
            </when>

            <when test="filter != null and type.equals('userNo')">
                AND USER_NO = #{userNo}
            </when>

        </choose>
    </select>

    <!-- 게시글 목록 조회 (검색+페이징) -->
    <select id="searchListCount" resultType="com.inssa.server.api.board.dto.BoardDto" >
        SELECT CNT, (SELECT BOARD_GUBUN FROM BOARD ) BOARD_GUBUN
        FROM
            SELECT COUNT(*) CNT
            FROM BOARD
            WHERE BOARD_GUBUN = 'R'
            AND BOARD_STATUS = 'Y'
            <choose>
                <when test="filter != null and type.equals('searchWord')">
                    AND searchWord LIKE CONCAT('%', #{boardTitle}, '%')
                </when>

                <when test="filter != null and type.equals('searchWord')">
                    AND searchWord LIKE CONCAT('%', #{boardContent}, '%')
                </when>

                <when test="filter != null and type.equals('category')">
                    AND BOARD_CATEGORY = #{boardCategory}
                </when>

                <when test="filter != null and type.equals('userNo')">
                    AND USER_NO = #{userNo}
                </when>

            </choose>
    </select>

    <!-- 게시판 조회수 증가 -->
    <update id="updateView" parameterType="int">
        UPDATE BOARD
        SET
        BOARD_VIEW = BOARD_VIEW + 1
        WHERE BOARD_NO = #{boardNo}
    </update>

    <!-- 게시판 좋아요  -->
    <update id="updateLike" parameterType="com.inssa.server.api.board.dto.BoardDto">
        UPDATE BOARD
        SET
        BOARD_LIKE = #{boardLike}
        WHERE BOARD_NO = #{boardNo}
        AND USER_NO = #{userNo}
    </update>

    <!-- 게시판 찜  -->
    <update id="updateZzim" parameterType="com.inssa.server.api.board.dto.BoardDto">
        UPDATE BOARD
        SET
        BOARD_ZZIM = #{boardZzim}
        WHERE BOARD_NO = #{boardNo}
        AND USER_NO = #{userNo}
    </update>

    <!-- 게시글 별점 평가  -->
    <update id="updateStar" parameterType="com.inssa.server.api.board.dto.BoardDto">
        UPDATE BOARD
        SET
        BOARD_STAR = #{boardStar}
        WHERE BOARD_NO = #{boardNo}
        AND USER_NO = #{userNo}
    </update>

</mapper>